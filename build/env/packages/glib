#!/bin/sh
# This file is automatically generated by fs-package
set -e

# FIXME: libffi?
# libiconv?

build/env/packages/gettext
build/env/packages/libiconv
build/env/packages/zlib

PACKAGE=glib-2.84.2
CHECKSUM=88e960dd937057407d61fcb3b45a860704b25923c37ae2478b85f2ecb5a4021f
REVISION=1

. build/env/scripts/package.sh

# FIXME: Would be nice to extract 2.84 from PACKAGE
build/env/scripts/download.py \
https://download.gnome.org/sources/glib/2.84/$PACKAGE.tar.xz \
sha256:$CHECKSUM

rm -Rf build/env/_temp && mkdir build/env/_temp && cd build/env/_temp
tar xf ../_sources/$PACKAGE.tar.xz || true
cd $PACKAGE

#python3 ../../replace.py \
#gio/tests/meson.build \
#"if not meson.is_cross_build() or meson.has_exe_wrapper()" \
#"if false"

#-Dinternal_pcre=true \

# replace meson.build "subdir('po')" ""

meson setup \
    --prefix $PREFIX \
    --libdir lib \
    --force-fallback-for libpcre2-8 \
    _build 
meson compile -C _build
meson install -C _build

#ninja -C _build
#ninja -C _build install

# if [ "$SYSTEM_OS" = "macOS" ]; then
# DYLIB=libglib-2.0.0.dylib
# install_name_tool -id @rpath/$DYLIB $PREFIX/lib/$DYLIB
# fi

if [ "$SYSTEM_OS" = "Linux" ]; then
patchelf --set-rpath $PREFIX/lib $PREFIX/lib/libglib-2.0.so
fi

touch $INSTALLED
