#!/usr/bin/env python3
# This file is automatically generated by fs-package

import os
import subprocess
import sys
import time
import xml.etree.ElementTree as ET

package = {}
with open("PACKAGE.FS", "r") as f:
    for line in f:
        try:
            key, value = line.strip().split("=", 1)
            package[key] = value
        except ValueError:
            pass
if package["PACKAGE_TYPE"] == "fs-data-plugin":
    print("Not signing data plugin")
    sys.exit(0)
package_name_pretty = package["PACKAGE_NAME_PRETTY"]
bundle_id = package["PACKAGE_MACOS_BUNDLE_ID"]
app = package_name_pretty + ".app"
framework = package_name_pretty + ".framework"
arch = "x86-64"  # FIXME

apple_id_user = os.environ.get("NOTARIZATION_USERNAME", "")
itc_provider = os.environ.get("NOTARIZATION_PROVIDER", "")


def macos_bundle_path():
    path = f"fsbuild/_build/{package_name_pretty}/macOS/{arch}/{app}"
    if os.path.exists(path):
        return path
    path = f"fsbuild/_build/{package_name_pretty}/macOS/{arch}/{framework}"
    if os.path.exists(path):
        return path
    raise Exception("Could not find any app or framework bundle")


def shell(cmd):
    print(cmd)
    return subprocess.run(
        cmd, shell=True, check=True, stdout=subprocess.PIPE).stdout.decode("UTF-8")


def main():
    if sys.platform != "darwin":
        print("Skipping notarize step (Not a macOS build)")
        return
    bundle_path = macos_bundle_path()
    bundle = os.path.basename(bundle_path)
    bundle_parent_dir = os.path.dirname(bundle_path)
    shell("rm -f fsbuild/_build/notarize.zip")
    zip = "../../../notarize.zip"
    shell(f'cd {bundle_parent_dir} && ditto -c -k --keepParent "{bundle}" "{zip}"')
    result = shell(
        "xcrun altool --notarize-app -t osx "
        "-f fsbuild/_build/notarize.zip "
        "--primary-bundle-id {bundle_id} "
        "-u {apple_id_user} "
        "-p @env:NOTARIZATION_PASSWORD "
        "-itc_provider {itc_provider} "
        "--output-format xml".format(
            bundle_id=bundle_id,
            apple_id_user=apple_id_user,
            itc_provider=itc_provider,
        )
    )

    print(result)
    root = ET.fromstring(result)
    dict = root.find("dict")
    print(dict)
    request_uuid = dict.find("dict").find("string").text
    print(request_uuid)

    for i in range(60):
        time.sleep(10.0)
        result = shell(
            "xcrun altool --notarization-info {} "
            "-u {} -p @env:NOTARIZATION_PASSWORD "
            "-itc_provider {} --output-format xml".format(
                request_uuid, apple_id_user, itc_provider
            )
        )
        if "<string>success</string>" in result:
            break
        elif "<string>in progress</string>" in result:
            print("in progress...")
            continue
        else:
            print(result)
            raise Exception("...")

    if bundle_path.endswith(".framework"):
        print("Does not seem to be possible to staple tickets to frameworks? (error 73)")
        print("Exiting...")
        sys.exit(0)

    print('xcrun stapler staple "{}"'.format(bundle_path))
    assert os.system('xcrun stapler staple "{}"'.format(bundle_path)) == 0


if __name__ == "__main__":
    main()
